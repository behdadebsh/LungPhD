import numpy as np
import os
from scipy.optimize import linear_sum_assignment
import pyvista as pv
from annotate_clusters import get_cluster_centroids, filter_centroids_by_lobe


terminal_to_lobe = {'87': 'RUL', '88': 'RUL', '116': 'RUL', '117': 'RUL', '135': 'RUL', '141': 'RUL', '145': 'RUL', '79': 'RML', '81': 'RML', '100': 'RML', '109': 'RML', '110': 'RML', '95': 'RLL', '102': 'RLL', '122': 'RLL', '123': 'RLL', '139': 'RLL', '33': 'LUL', '38': 'LUL', '50': 'LUL', '52': 'LUL', '61': 'LUL', '64': 'LUL', '66': 'LUL', '129': 'LUL', '131': 'LUL', '23': 'LLL', '26': 'LLL', '42': 'LLL', '45': 'LLL', '125': 'LLL', '127': 'LLL', '56': 'LUL', '29': 'LLL'}
centreline_dict_final = {'1': {'branch': 0, 'coords': [21.28731346130371, -207.64659118652344, 1136.2332763671875], 'parent': [], 'child': ['2']}, '2': {'branch': 0, 'coords': [22.39055061340332, -205.3019256591797, 1144.225830078125], 'child': ['3'], 'parent': '1'}, '3': {'branch': 0, 'coords': [19.95615005493164, -200.82302856445312, 1149.8692626953125], 'child': ['4'], 'parent': '2'}, '4': {'branch': 0, 'coords': [19.208415985107422, -195.1857147216797, 1155.5987548828125], 'child': ['5'], 'parent': '3'}, '5': {'branch': 0, 'coords': [19.47334861755371, -188.58709716796875, 1160.2515869140625], 'child': ['6'], 'parent': '4'}, '6': {'branch': 0, 'coords': [19.40428352355957, -181.3438262939453, 1163.865966796875], 'child': ['7'], 'parent': '5'}, '7': {'branch': 0, 'coords': [18.613544464111328, -170.69775390625, 1165.3682861328125], 'duplicates': [{'node': '8', 'branch': 1}, {'node': '92', 'branch': 26}], 'child': ['8', '67'], 'parent': '6'}, '8': {'branch': 1, 'coords': [27.57729148864746, -153.9871063232422, 1172.3441162109375], 'parent': '7', 'child': ['9']}, '9': {'branch': 1, 'coords': [30.70146942138672, -146.62985229492188, 1174.0887451171875], 'child': ['10'], 'parent': '8'}, '10': {'branch': 1, 'coords': [35.93184280395508, -140.46246337890625, 1175.223876953125], 'child': ['11'], 'parent': '9'}, '11': {'branch': 1, 'coords': [42.32865905761719, -135.4086456298828, 1174.9859619140625], 'child': ['12', '13'], 'parent': '10'}, '12': {'branch': 1, 'coords': [47.063194274902344, -131.0526123046875, 1174.2872314453125], 'duplicates': [{'node': '14', 'branch': 2}, {'node': '71', 'branch': 19}, {'node': '77', 'branch': 21}], 'child': ['53', '57'], 'parent': '11'}, '13': {'branch': 2, 'coords': [52.65825653076172, -121.09703063964844, 1170.5447998046875], 'duplicates': [{'node': '16', 'branch': 3}, {'node': '38', 'branch': 9}, {'node': '44', 'branch': 11}, {'node': '51', 'branch': 13}], 'parent': '11', 'child': ['30', '34']}, '14': {'branch': 3, 'coords': [59.251434326171875, -106.0443344116211, 1150.4454345703125], 'parent': '30', 'child': ['15', '39']}, '15': {'branch': 3, 'coords': [60.228736877441406, -102.41643524169922, 1143.0855712890625], 'child': ['16'], 'parent': '14'}, '16': {'branch': 3, 'coords': [60.18320083618164, -101.95401000976562, 1141.568359375], 'duplicates': [{'node': '20', 'branch': 4}, {'node': '34', 'branch': 8}], 'child': ['17', '27'], 'parent': '15'}, '17': {'branch': 4, 'coords': [56.427642822265625, -95.7862548828125, 1133.6251220703125], 'parent': '16', 'child': ['18']}, '18': {'branch': 4, 'coords': [53.94446563720703, -92.75019073486328, 1126.5794677734375], 'child': ['19', '126'], 'parent': '17'}, '19': {'branch': 4, 'coords': [51.73912048339844, -90.3438720703125, 1121.4659423828125], 'duplicates': [{'node': '24', 'branch': 5}, {'node': '30', 'branch': 7}, {'node': '178', 'branch': 53}], 'child': ['20', '24'], 'parent': '18'}, '20': {'branch': 5, 'coords': [50.53813552856445, -87.35643768310547, 1110.187744140625], 'parent': '19', 'child': ['21']}, '21': {'branch': 5, 'coords': [51.88527297973633, -85.85701751708984, 1106.67431640625], 'duplicates': [{'node': '27', 'branch': 6}, {'node': '175', 'branch': 52}], 'child': ['22', '124'], 'parent': '20'}, '22': {'branch': 6, 'coords': [48.091697692871094, -81.05779266357422, 1099.08203125], 'parent': '21', 'child': ['23']}, '23': {'branch': 6, 'coords': [47.36857223510742, -79.68717956542969, 1097.7122802734375], 'child': [], 'parent': '22'}, '24': {'branch': 7, 'coords': [57.62025833129883, -81.05238342285156, 1121.1810302734375], 'parent': '19', 'child': ['25']}, '25': {'branch': 7, 'coords': [61.16157913208008, -81.72410583496094, 1114.3973388671875], 'child': ['26'], 'parent': '24'}, '26': {'branch': 7, 'coords': [58.874900817871094, -77.99706268310547, 1109.6995849609375], 'child': [], 'parent': '25'}, '27': {'branch': 8, 'coords': [64.36050415039062, -102.17619323730469, 1131.739990234375], 'parent': '16', 'child': ['28']}, '28': {'branch': 8, 'coords': [68.29898834228516, -99.8878173828125, 1125.1121826171875], 'child': ['29'], 'parent': '27'}, '29': {'branch': 8, 'coords': [71.55250549316406, -103.50299835205078, 1120.19873046875], 'child': [], 'parent': '28'}, '30': {'branch': 9, 'coords': [68.91044616699219, -119.76362609863281, 1154.82421875], 'parent': '13', 'child': ['31', '14']}, '31': {'branch': 9, 'coords': [70.00114440917969, -125.32730865478516, 1149.3699951171875], 'child': ['32'], 'parent': '30'}, '32': {'branch': 9, 'coords': [74.54078674316406, -128.87466430664062, 1145.17724609375], 'duplicates': [{'node': '42', 'branch': 10}, {'node': '181', 'branch': 54}], 'child': ['33', '128'], 'parent': '31'}, '33': {'branch': 10, 'coords': [78.00851440429688, -127.572509765625, 1135.9442138671875], 'parent': '32', 'child': []}, '34': {'branch': 11, 'coords': [64.41088104248047, -117.9070053100586, 1177.63720703125], 'duplicates': [{'node': '46', 'branch': 12}, {'node': '61', 'branch': 16}], 'parent': '13', 'child': ['35', '46']}, '35': {'branch': 12, 'coords': [69.3459701538086, -118.18399047851562, 1169.937744140625], 'parent': '34', 'child': ['36']}, '36': {'branch': 12, 'coords': [73.31861114501953, -111.8438720703125, 1171.2705078125], 'child': ['37'], 'parent': '35'}, '37': {'branch': 12, 'coords': [74.99151611328125, -104.63056945800781, 1173.5445556640625], 'child': ['38'], 'parent': '36'}, '38': {'branch': 12, 'coords': [75.77656555175781, -103.0439682006836, 1172.5487060546875], 'child': [], 'parent': '37'}, '39': {'branch': 13, 'coords': [56.89166259765625, -100.9108657836914, 1167.8387451171875], 'parent': '14', 'child': ['40']}, '40': {'branch': 13, 'coords': [56.380393981933594, -99.55786895751953, 1167.909912109375], 'duplicates': [{'node': '54', 'branch': 14}, {'node': '57', 'branch': 15}], 'child': ['41', '43'], 'parent': '39'}, '41': {'branch': 14, 'coords': [47.228023529052734, -95.49237060546875, 1169.7674560546875], 'parent': '40', 'child': ['42']}, '42': {'branch': 14, 'coords': [47.52252960205078, -90.5469741821289, 1174.2896728515625], 'child': [], 'parent': '41'}, '43': {'branch': 15, 'coords': [55.96592330932617, -90.45184326171875, 1164.0068359375], 'parent': '40', 'child': ['44']}, '44': {'branch': 15, 'coords': [57.68668746948242, -84.80203247070312, 1159.152587890625], 'child': ['45'], 'parent': '43'}, '45': {'branch': 15, 'coords': [56.11250305175781, -77.35372924804688, 1158.4710693359375], 'child': [], 'parent': '44'}, '46': {'branch': 16, 'coords': [67.00408935546875, -110.83885955810547, 1182.5380859375], 'parent': '34', 'child': ['47']}, '47': {'branch': 16, 'coords': [64.17922973632812, -106.41439056396484, 1188.8782958984375], 'child': ['48'], 'parent': '46'}, '48': {'branch': 16, 'coords': [63.49319839477539, -105.41808319091797, 1193.655029296875], 'duplicates': [{'node': '65', 'branch': 17}, {'node': '68', 'branch': 18}], 'child': ['49', '51'], 'parent': '47'}, '49': {'branch': 17, 'coords': [62.89113998413086, -109.48002624511719, 1202.1256103515625], 'parent': '48', 'child': ['50']}, '50': {'branch': 17, 'coords': [58.49513626098633, -107.98993682861328, 1208.7232666015625], 'child': [], 'parent': '49'}, '51': {'branch': 18, 'coords': [63.40420150756836, -96.58033752441406, 1197.9619140625], 'parent': '48', 'child': ['52']}, '52': {'branch': 18, 'coords': [65.35564422607422, -93.027099609375, 1200.356201171875], 'child': [], 'parent': '51'}, '53': {'branch': 19, 'coords': [64.55264282226562, -131.62396240234375, 1181.0738525390625], 'parent': '12', 'child': ['54']}, '54': {'branch': 19, 'coords': [67.96588897705078, -130.458984375, 1188.37109375], 'child': ['55'], 'parent': '53'}, '55': {'branch': 19, 'coords': [68.91226959228516, -131.9453125, 1192.9136962890625], 'duplicates': [{'node': '75', 'branch': 20}, {'node': '84', 'branch': 23}], 'child': ['56', '62'], 'parent': '54'}, '56': {'branch': 20, 'coords': [73.557373046875, -129.35501098632812, 1193.2247314453125], 'parent': '55', 'child': []}, '57': {'branch': 21, 'coords': [64.25959777832031, -138.13218688964844, 1171.2413330078125], 'parent': '12', 'child': ['58']}, '58': {'branch': 21, 'coords': [71.0851058959961, -139.24891662597656, 1167.2625732421875], 'child': ['59'], 'parent': '57'}, '59': {'branch': 21, 'coords': [76.66732788085938, -143.6222686767578, 1164.39794921875], 'duplicates': [{'node': '81', 'branch': 22}, {'node': '184', 'branch': 55}], 'child': ['60', '130'], 'parent': '58'}, '60': {'branch': 22, 'coords': [84.29634857177734, -144.7790985107422, 1158.6732177734375], 'parent': '59', 'child': ['61']}, '61': {'branch': 22, 'coords': [88.92959594726562, -146.05906677246094, 1157.4864501953125], 'child': [], 'parent': '60'}, '62': {'branch': 23, 'coords': [66.36148834228516, -138.9237823486328, 1197.9525146484375], 'duplicates': [{'node': '86', 'branch': 24}, {'node': '89', 'branch': 25}], 'parent': '55', 'child': ['63', '65']}, '63': {'branch': 24, 'coords': [63.25835037231445, -141.04232788085938, 1206.681884765625], 'parent': '62', 'child': ['64']}, '64': {'branch': 24, 'coords': [62.91157531738281, -141.1206512451172, 1209.70263671875], 'child': [], 'parent': '63'}, '65': {'branch': 25, 'coords': [72.10079193115234, -145.6388702392578, 1197.8739013671875], 'parent': '62', 'child': ['66']}, '66': {'branch': 25, 'coords': [72.87183380126953, -145.93312072753906, 1198.531982421875], 'child': [], 'parent': '65'}, '67': {'branch': 26, 'coords': [4.535946846008301, -157.13247680664062, 1158.8236083984375], 'parent': '7', 'child': ['68']}, '68': {'branch': 26, 'coords': [-1.9163587093353271, -152.50070190429688, 1157.75830078125], 'child': ['69'], 'parent': '67'}, '69': {'branch': 26, 'coords': [-9.01720142364502, -148.71441650390625, 1157.928955078125], 'child': ['70'], 'parent': '68'}, '70': {'branch': 26, 'coords': [-15.929819107055664, -144.64051818847656, 1157.9346923828125], 'child': ['71'], 'parent': '69'}, '71': {'branch': 26, 'coords': [-19.97347068786621, -142.7924041748047, 1158.319091796875], 'duplicates': [{'node': '98', 'branch': 27}, {'node': '112', 'branch': 31}], 'child': ['72', '82'], 'parent': '70'}, '72': {'branch': 27, 'coords': [-32.715274810791016, -135.95315551757812, 1152.8592529296875], 'parent': '71', 'child': ['73']}, '73': {'branch': 27, 'coords': [-40.41075897216797, -133.34933471679688, 1152.582763671875], 'child': ['74', '75'], 'parent': '72'}, '74': {'branch': 27, 'coords': [-46.48979568481445, -130.26123046875, 1151.161865234375], 'duplicates': [{'node': '102', 'branch': 28}, {'node': '124', 'branch': 36}, {'node': '134', 'branch': 39}], 'child': ['89', '96'], 'parent': '73'}, '75': {'branch': 28, 'coords': [-60.030460357666016, -136.79664611816406, 1145.47216796875], 'parent': '73', 'child': ['76']}, '76': {'branch': 28, 'coords': [-62.192291259765625, -144.31971740722656, 1143.3255615234375], 'child': ['77', '103'], 'parent': '75'}, '77': {'branch': 28, 'coords': [-61.73442840576172, -147.33663940429688, 1142.061279296875], 'duplicates': [{'node': '106', 'branch': 29}, {'node': '109', 'branch': 30}, {'node': '144', 'branch': 42}], 'child': ['78', '80'], 'parent': '76'}, '78': {'branch': 29, 'coords': [-54.52404022216797, -153.99708557128906, 1139.6722412109375], 'parent': '77', 'child': ['79']}, '79': {'branch': 29, 'coords': [-54.352317810058594, -160.80224609375, 1139.118408203125], 'child': [], 'parent': '78'}, '80': {'branch': 30, 'coords': [-60.29364013671875, -151.5719451904297, 1131.9136962890625], 'parent': '77', 'child': ['81']}, '81': {'branch': 30, 'coords': [-61.08326721191406, -153.93484497070312, 1128.8726806640625], 'child': [], 'parent': '80'}, '82': {'branch': 31, 'coords': [-30.395008087158203, -140.3287353515625, 1169.6845703125], 'parent': '71', 'child': ['83']}, '83': {'branch': 31, 'coords': [-36.51862716674805, -137.95516967773438, 1174.4962158203125], 'child': ['84'], 'parent': '82'}, '84': {'branch': 31, 'coords': [-39.91157913208008, -135.7762908935547, 1179.765625], 'duplicates': [{'node': '116', 'branch': 32}, {'node': '187', 'branch': 56}], 'child': ['85', '132'], 'parent': '83'}, '85': {'branch': 32, 'coords': [-42.895755767822266, -131.7772216796875, 1183.44970703125], 'duplicates': [{'node': '118', 'branch': 33}, {'node': '155', 'branch': 45}], 'parent': '84', 'child': ['86', '111']}, '86': {'branch': 33, 'coords': [-47.08466720581055, -131.8441162109375, 1194.002685546875], 'duplicates': [{'node': '120', 'branch': 34}, {'node': '122', 'branch': 35}], 'parent': '85', 'child': ['87', '88']}, '87': {'branch': 34, 'coords': [-55.40719985961914, -133.9622802734375, 1197.7933349609375], 'parent': '86', 'child': []}, '88': {'branch': 35, 'coords': [-44.96387481689453, -130.58335876464844, 1200.0877685546875], 'parent': '86', 'child': []}, '89': {'branch': 36, 'coords': [-49.67647171020508, -119.98017883300781, 1147.9195556640625], 'duplicates': [{'node': '126', 'branch': 37}, {'node': '192', 'branch': 57}], 'parent': '74', 'child': ['90', '136']}, '90': {'branch': 37, 'coords': [-52.54399108886719, -115.42729187011719, 1140.2518310546875], 'parent': '89', 'child': ['91']}, '91': {'branch': 37, 'coords': [-50.84800720214844, -111.2282943725586, 1134.5716552734375], 'child': ['92'], 'parent': '90'}, '92': {'branch': 37, 'coords': [-50.24833679199219, -109.0966567993164, 1131.7083740234375], 'duplicates': [{'node': '130', 'branch': 38}, {'node': '166', 'branch': 49}], 'child': ['93', '118'], 'parent': '91'}, '93': {'branch': 38, 'coords': [-56.36742401123047, -103.35344696044922, 1126.481689453125], 'parent': '92', 'child': ['94']}, '94': {'branch': 38, 'coords': [-61.45836639404297, -97.65750885009766, 1123.467041015625], 'child': ['95'], 'parent': '93'}, '95': {'branch': 38, 'coords': [-61.750301361083984, -97.01206970214844, 1122.78955078125], 'child': [], 'parent': '94'}, '96': {'branch': 39, 'coords': [-52.93217849731445, -121.98957061767578, 1141.5009765625], 'parent': '74', 'child': ['97']}, '97': {'branch': 39, 'coords': [-55.72169876098633, -119.65255737304688, 1134.9931640625], 'child': ['98'], 'parent': '96'}, '98': {'branch': 39, 'coords': [-55.67826843261719, -122.34934997558594, 1127.536865234375], 'child': ['99'], 'parent': '97'}, '99': {'branch': 39, 'coords': [-55.74229431152344, -122.77769470214844, 1125.01953125], 'duplicates': [{'node': '139', 'branch': 40}, {'node': '141', 'branch': 41}], 'child': ['100', '101'], 'parent': '98'}, '100': {'branch': 40, 'coords': [-52.71717834472656, -124.90816497802734, 1121.849609375], 'parent': '99', 'child': []}, '101': {'branch': 41, 'coords': [-63.38727569580078, -120.14042663574219, 1120.659912109375], 'parent': '99', 'child': ['102']}, '102': {'branch': 41, 'coords': [-66.61456298828125, -118.25042724609375, 1118.7880859375], 'child': [], 'parent': '101'}, '103': {'branch': 42, 'coords': [-62.38525390625, -157.94357299804688, 1139.4539794921875], 'parent': '76', 'child': ['104']}, '104': {'branch': 42, 'coords': [-63.466217041015625, -165.62660217285156, 1137.549560546875], 'child': ['105'], 'parent': '103'}, '105': {'branch': 42, 'coords': [-64.27796936035156, -173.29248046875, 1135.5], 'child': ['106'], 'parent': '104'}, '106': {'branch': 42, 'coords': [-64.86951446533203, -180.77459716796875, 1132.6998291015625], 'child': ['107'], 'parent': '105'}, '107': {'branch': 42, 'coords': [-65.56714630126953, -186.9617462158203, 1130.1317138671875], 'duplicates': [{'node': '150', 'branch': 43}, {'node': '153', 'branch': 44}], 'child': ['108', '110'], 'parent': '106'}, '108': {'branch': 43, 'coords': [-71.39006042480469, -194.02960205078125, 1128.004638671875], 'parent': '107', 'child': ['109']}, '109': {'branch': 43, 'coords': [-71.96446228027344, -194.83251953125, 1128.1009521484375], 'child': [], 'parent': '108'}, '110': {'branch': 44, 'coords': [-62.364044189453125, -193.93052673339844, 1127.5584716796875], 'parent': '107', 'child': []}, '111': {'branch': 45, 'coords': [-49.361873626708984, -126.82794952392578, 1186.9815673828125], 'parent': '85', 'child': ['112', '113']}, '112': {'branch': 45, 'coords': [-51.1622428894043, -125.37726593017578, 1187.256591796875], 'duplicates': [{'node': '158', 'branch': 46}, {'node': '197', 'branch': 58}, {'node': '200', 'branch': 59}], 'child': ['140', '142'], 'parent': '111'}, '113': {'branch': 46, 'coords': [-58.32866287231445, -117.77216339111328, 1186.5360107421875], 'parent': '111', 'child': ['114']}, '114': {'branch': 46, 'coords': [-59.327247619628906, -116.3962173461914, 1186.6483154296875], 'duplicates': [{'node': '161', 'branch': 47}, {'node': '164', 'branch': 48}], 'child': ['115', '117'], 'parent': '113'}, '115': {'branch': 47, 'coords': [-64.75648498535156, -109.96149444580078, 1185.0338134765625], 'parent': '114', 'child': ['116']}, '116': {'branch': 47, 'coords': [-65.05294036865234, -107.14196014404297, 1185.1929931640625], 'child': [], 'parent': '115'}, '117': {'branch': 48, 'coords': [-58.787391662597656, -113.84465026855469, 1189.4244384765625], 'parent': '114', 'child': []}, '118': {'branch': 49, 'coords': [-46.3586540222168, -103.11353302001953, 1125.7646484375], 'parent': '92', 'child': ['119']}, '119': {'branch': 49, 'coords': [-44.505374908447266, -98.44780731201172, 1119.3218994140625], 'child': ['120'], 'parent': '118'}, '120': {'branch': 49, 'coords': [-45.7993049621582, -95.84510040283203, 1112.0941162109375], 'duplicates': [{'node': '170', 'branch': 50}, {'node': '173', 'branch': 51}], 'child': ['121', '123'], 'parent': '119'}, '121': {'branch': 50, 'coords': [-43.044029235839844, -94.26051330566406, 1103.3087158203125], 'parent': '120', 'child': ['122']}, '122': {'branch': 50, 'coords': [-42.272186279296875, -93.76101684570312, 1100.28759765625], 'child': [], 'parent': '121'}, '123': {'branch': 51, 'coords': [-50.9903450012207, -94.43933868408203, 1108.8538818359375], 'parent': '120', 'child': []}, '124': {'branch': 52, 'coords': [56.30534744262695, -86.54749298095703, 1099.1165771484375], 'parent': '21', 'child': ['125']}, '125': {'branch': 52, 'coords': [57.016605377197266, -85.92813110351562, 1095.197021484375], 'child': [], 'parent': '124'}, '126': {'branch': 53, 'coords': [46.33524703979492, -96.44012451171875, 1114.6541748046875], 'parent': '18', 'child': ['127']}, '127': {'branch': 53, 'coords': [49.0393180847168, -96.5291748046875, 1113.0550537109375], 'child': [], 'parent': '126'}, '128': {'branch': 54, 'coords': [83.4325180053711, -131.47470092773438, 1142.5986328125], 'parent': '32', 'child': ['129']}, '129': {'branch': 54, 'coords': [85.88553619384766, -131.7972412109375, 1140.6982421875], 'child': [], 'parent': '128'}, '130': {'branch': 55, 'coords': [76.11576080322266, -154.34719848632812, 1162.950927734375], 'parent': '59', 'child': ['131']}, '131': {'branch': 55, 'coords': [73.89962768554688, -157.5092315673828, 1162.024658203125], 'child': [], 'parent': '130'}, '132': {'branch': 56, 'coords': [-46.225704193115234, -141.47068786621094, 1188.2154541015625], 'parent': '84', 'child': ['133']}, '133': {'branch': 56, 'coords': [-48.129798889160156, -146.52963256835938, 1194.283203125], 'child': ['134'], 'parent': '132'}, '134': {'branch': 56, 'coords': [-50.212913513183594, -150.4630584716797, 1201.0244140625], 'child': ['135'], 'parent': '133'}, '135': {'branch': 56, 'coords': [-49.46110153198242, -153.55154418945312, 1205.012939453125], 'child': [], 'parent': '134'}, '136': {'branch': 57, 'coords': [-55.75111389160156, -113.8844223022461, 1150.5062255859375], 'parent': '89', 'child': ['137']}, '137': {'branch': 57, 'coords': [-57.360233306884766, -107.00547790527344, 1146.767578125], 'child': ['138'], 'parent': '136'}, '138': {'branch': 57, 'coords': [-60.88047790527344, -100.98163604736328, 1142.9677734375], 'child': ['139'], 'parent': '137'}, '139': {'branch': 57, 'coords': [-62.957027435302734, -93.55720520019531, 1140.845703125], 'child': [], 'parent': '138'}, '140': {'branch': 58, 'coords': [-50.39179229736328, -117.47419738769531, 1188.6787109375], 'parent': '112', 'child': ['141']}, '141': {'branch': 58, 'coords': [-46.5936393737793, -114.49292755126953, 1191.847900390625], 'child': [], 'parent': '140'}, '142': {'branch': 59, 'coords': [-60.53170394897461, -125.44720458984375, 1183.3609619140625], 'parent': '112', 'child': ['143']}, '143': {'branch': 59, 'coords': [-68.22945404052734, -126.6211929321289, 1181.340087890625], 'child': ['144'], 'parent': '142'}, '144': {'branch': 59, 'coords': [-76.22578430175781, -126.96017456054688, 1180.7686767578125], 'child': ['145'], 'parent': '143'}, '145': {'branch': 59, 'coords': [-80.09489440917969, -126.0973892211914, 1181.22412109375], 'parent': '144', 'child': []}}

# -------------- Settings ----------------------
distance_weight = 0.5
angle_weight = 1.0
root_folder = '/hpc/bsha219/lung/Data'
study = 'CTEPH'
protocol = 'Pre'
subject_name = 'Alfred12'
subject_path = os.path.join(root_folder, study, subject_name, protocol)
ply_directory = os.path.join(root_folder, study, subject_name, protocol, 'Lobe', 'Lobe_mesh')

# --- Load cluster centroids ---
centroid_dict = get_cluster_centroids(os.path.join(subject_path, 'Intensity_mapping'))

# --- Organize centroids per lobe ---
lobe_centroids = {
    "RUL": filter_centroids_by_lobe(centroid_dict, "RUL"),
    "RML": filter_centroids_by_lobe(centroid_dict, "RML"),
    "RLL": filter_centroids_by_lobe(centroid_dict, "RLL"),
    "LUL": filter_centroids_by_lobe(centroid_dict, "LUL"),
    "LLL": filter_centroids_by_lobe(centroid_dict, "LLL"),
}

# --- Prepare final mapping ---
final_mapping = {}

# --- For each lobe, do the assignment ---
for lobe_name, centroids in lobe_centroids.items():
    if not centroids:
        continue  # Skip if no centroids for this lobe

    # Get terminals for this lobe
    terminals_list = [node for node, lobe in terminal_to_lobe.items() if lobe == lobe_name]

    # Get terminal coordinates and branch vectors
    terminal_coords = []
    branch_vectors = []

    for terminal in terminals_list:
        terminal_point = np.array(centreline_dict_final[terminal]['coords'])
        parent = centreline_dict_final[terminal]['parent']
        parent_point = np.array(centreline_dict_final[parent]['coords'])

        vector = terminal_point - parent_point
        vector = vector / np.linalg.norm(vector)

        terminal_coords.append(terminal_point)
        branch_vectors.append(vector)

    terminal_coords = np.array(terminal_coords)
    branch_vectors = np.array(branch_vectors)

    # Prepare centroids
    centroid_ids = list(centroids.keys())
    centroid_coords = np.array([centroids[cid] for cid in centroid_ids])

    num_terminals = len(terminal_coords)
    num_centroids = len(centroid_coords)

    # Build cost matrix
    cost_matrix = np.zeros((num_terminals, num_centroids))

    for i, (t_coord, t_vec) in enumerate(zip(terminal_coords, branch_vectors)):
        for j, c_coord in enumerate(centroid_coords):
            distance = np.linalg.norm(t_coord - c_coord)
            t_to_c_vec = c_coord - t_coord
            t_to_c_vec = t_to_c_vec / np.linalg.norm(t_to_c_vec)
            cosine_similarity = np.dot(t_vec, t_to_c_vec)
            angle_cost = 1 - cosine_similarity
            total_cost = distance_weight * distance + angle_weight * angle_cost
            cost_matrix[i, j] = total_cost

    # Assignment
    final_assignments = []
    terminal_usage = {i: 0 for i in range(num_terminals)}

    for j in range(num_centroids):
        available_terminals = [i for i in range(num_terminals) if terminal_usage[i] == 0]

        if available_terminals:
            costs = [cost_matrix[i, j] for i in available_terminals]
            best_terminal_idx = available_terminals[np.argmin(costs)]
        else:
            costs = [cost_matrix[i, j] for i in range(num_terminals)]
            best_terminal_idx = np.argmin(costs)

        final_assignments.append((best_terminal_idx, j))
        terminal_usage[best_terminal_idx] += 1

    # Store mapping
    for terminal_idx, centroid_idx in final_assignments:
        terminal_node = terminals_list[terminal_idx]
        centroid_id = centroid_ids[centroid_idx]

        final_mapping[terminal_node] = {
            "terminal_element": centreline_dict_final[terminal_node]['branch'],
            "cluster_id": centroid_id,
        }

# --- Final Output ---
print("Final Mapping:")
for terminal_node, info in final_mapping.items():
    print(f"Terminal {terminal_node} (Element {info['terminal_element']}) → Cluster {info['cluster_id']}")

